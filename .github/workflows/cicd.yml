# ------------------------------------------------------------------------------
# GitHub Actions â”ƒ Docker Image CI Â· Gradle & Docker-Layer Caching Â· Prod ë°°í¬
# ------------------------------------------------------------------------------
# ëª©ì 
#   1. main ë¸Œëœì¹˜ push â†’ í…ŒìŠ¤íŠ¸ â†’ Docker ì´ë¯¸ì§€ ë¹Œë“œ â†’ GHCR í‘¸ì‹œ
#   2. Gradle ì½ê¸° ì „ìš© ìºì‹œ + Docker Layer ìºì‹œë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
#   3. ë¹Œë“œÂ·ë°°í¬ ê²°ê³¼ë¥¼ Slack Webhook í†µë³´
#   4. ë¹Œë“œ ì„±ê³µ ì‹œ EC2(SSH) ë¬´ì¤‘ë‹¨ ì¬ë°°í¬
# AWS ì¤€ë¹„
#   â€¢ EC2ì— Docker ì„¤ì¹˜, ë³´ì•ˆê·¸ë£¹ 22/80(443) ê°œë°©
#   â€¢ í‚¤í˜ì–´(PEM) ìƒì„± í›„ GitHub Secret SSH_PRIVATE_KEY ë“±ë¡
#   â€¢ SSH_USER(ec2-user/ubuntu), SSH_HOST(í¼ë¸”ë¦­ IP), SLACK_WEBHOOK_URL ì¶”ê°€
# ------------------------------------------------------------------------------

name: docker-image-ci                # ì›Œí¬í”Œë¡œ ì´ë¦„ ì •ì˜

on:                                   # íŠ¸ë¦¬ê±° ì¡°ê±´ ì„¤ì •
  push:                               # git push ì´ë²¤íŠ¸ ê°ì§€
    branches: [ main ]               # main ë¸Œëœì¹˜ í‘¸ì‹œë§Œ ë°˜ì‘

env:                                   # ì „ì²´ ì›Œí¬í”Œë¡œ í™˜ê²½ë³€ìˆ˜
  REGISTRY: ghcr.io                  # GitHub Container Registry ì£¼ì†Œ
  IMAGE_NAME: ${{ github.repository }} # ì´ë¯¸ì§€ëª… = ë ˆí¬ì§€í† ë¦¬ëª…

concurrency:                           # ë™ì‹œ ì‹¤í–‰ ì œì–´ ì„¤ì •
  group: ci-${{ github.ref }}        # ë¸Œëœì¹˜ë³„ ê·¸ë£¹í•‘
  cancel-in-progress: true           # ìƒˆ ì‹¤í–‰ ì‹œ ê¸°ì¡´ ì‹¤í–‰ ì·¨ì†Œ

jobs:                                  # ì¡ ì •ì˜ ì‹œì‘
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) Build Â· Test Â· Push ì¡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-push:                      # ë¹Œë“œ/í‘¸ì‹œ ì¡ ID
    runs-on: ubuntu-latest           # Ubuntu ìµœì‹  ëŸ¬ë„ˆ ì‚¬ìš©
    permissions:                      # í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
      contents: read                # ì†ŒìŠ¤ì½”ë“œ ì½ê¸° ê¶Œí•œ
      packages: write               # íŒ¨í‚¤ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì“°ê¸° ê¶Œí•œ

    steps:                             # ì‹¤í–‰ ë‹¨ê³„ ì •ì˜
    - name: Checkout code             # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4      # ìµœì‹  ì²´í¬ì•„ì›ƒ ì•¡ì…˜ ì‚¬ìš©

    - name: Set up JDK 17            # Java 17 ì„¤ì¹˜
      uses: actions/setup-java@v4    # Java ì„¤ì • ì•¡ì…˜ ì‚¬ìš©
      with:
        distribution: temurin       # Eclipse Temurin ë°°í¬íŒ
        java-version: 17            # JDK ë²„ì „ 17 ì§€ì •
        cache: gradle               # Gradle ì˜ì¡´ì„± ìºì‹œ í™œì„±í™”

    - name: Setup Gradle             # Gradle ì„¤ì •
      uses: gradle/actions/setup-gradle@v3 # Gradle ì•¡ì…˜ ì‚¬ìš©
      with:
        cache-read-only: true        # ì½ê¸° ì „ìš© ìºì‹œ (CIì—ì„œ ê¶Œì¥)

    - name: Make gradlew executable  # gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      run: chmod +x ./gradlew        # Linux ì‹¤í–‰ ê¶Œí•œ ì„¤ì •

    - name: Run unit tests           # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: ./gradlew --no-daemon --build-cache --parallel test # ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

    - name: Set up Docker Buildx     # Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3 # ë©€í‹°í”Œë«í¼ ë¹Œë“œ ì§€ì›

    - name: Log in to GHCR           # GitHub Container Registry ë¡œê·¸ì¸
      uses: docker/login-action@v3   # Docker ë¡œê·¸ì¸ ì•¡ì…˜
      with:
        registry: ${{ env.REGISTRY }} # GHCR ì£¼ì†Œ
        username: ${{ github.actor }} # GitHub ì‚¬ìš©ìëª…
        password: ${{ secrets.GITHUB_TOKEN }} # GitHub ìë™ í† í°

    - name: Extract Docker metadata  # Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      id: meta                       # ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì°¸ì¡°í•  ID
      uses: docker/metadata-action@v5 # íƒœê·¸/ë¼ë²¨ ìë™ ìƒì„±
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} # ì´ë¯¸ì§€ ì „ì²´ ê²½ë¡œ

    - name: Build & push image       # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      uses: docker/build-push-action@v6 # ë¹Œë“œ í‘¸ì‹œ ì•¡ì…˜
      with:
        context: .                   # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œ
        file: ./Dockerfile           # Dockerfile ìœ„ì¹˜
        push: true                   # ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œ ì—¬ë¶€
        tags: ${{ steps.meta.outputs.tags }}   # ìƒì„±ëœ íƒœê·¸ ì ìš©
        labels: ${{ steps.meta.outputs.labels }} # ìƒì„±ëœ ë¼ë²¨ ì ìš©
        cache-from: type=gha         # GitHub Actions ìºì‹œì—ì„œ ì½ê¸°
        cache-to: type=gha,mode=max  # GitHub Actions ìºì‹œì— ì €ì¥

    - name: Slack notify (CI)        # CI ê²°ê³¼ Slack ì•Œë¦¼
      if: always()                   # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰
      uses: act10ns/slack@v2.1.0     # Slack ì•Œë¦¼ ì•¡ì…˜
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }} # Slack Webhook URL
        status: ${{ job.status }}    # ì¡ ì‹¤í–‰ ìƒíƒœ
        message: |                   # ì•Œë¦¼ ë©”ì‹œì§€ ë‚´ìš©
          *CI Build* `${{ github.repository }}`
          â€¢ *Status:* `${{ job.status }}`
          â€¢ *Branch:* `${{ github.ref_name }}`  *Commit:* `${{ github.sha }}`
          â€¢ *Image:* `${{ steps.meta.outputs.tags }}`
          â€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Logs>

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) Production Deploy (SSH)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-prod:                        # í”„ë¡œë•ì…˜ ë°°í¬ ì¡ ID
    needs: build-and-push           # ë¹Œë“œ ì¡ ì„±ê³µ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest          # Ubuntu ìµœì‹  ëŸ¬ë„ˆ ì‚¬ìš©
    if: github.ref == 'refs/heads/main' # main ë¸Œëœì¹˜ì¼ ë•Œë§Œ ì‹¤í–‰

    steps:                           # ë°°í¬ ë‹¨ê³„
    - name: Redeploy via SSH        # SSHë¡œ ì„œë²„ ì¬ë°°í¬
      uses: appleboy/ssh-action@v1.0.3 # SSH ì ‘ì† ì•¡ì…˜
      with:
        host: ${{ secrets.SSH_HOST }}   # ëŒ€ìƒ ì„œë²„ í˜¸ìŠ¤íŠ¸
        username: ${{ secrets.SSH_USER }} # SSH ì‚¬ìš©ìëª…
        key: ${{ secrets.SSH_PRIVATE_KEY }} # SSH ê°œì¸í‚¤
        script: |                    # ì›ê²© ì„œë²„ì—ì„œ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
          set -e                     # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main # ë°°í¬í•  ì´ë¯¸ì§€
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin # GHCR ë¡œê·¸ì¸
          docker pull $IMAGE         # ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
          docker rm -f app || true   # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ê°•ì œ ì œê±°
          docker run -d --name app -p 80:8080 --restart unless-stopped $IMAGE # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰

    - name: Slack notify (deploy)    # ë°°í¬ ê²°ê³¼ Slack ì•Œë¦¼
      if: always()                   # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰
      uses: act10ns/slack@v2.1.0     # Slack ì•Œë¦¼ ì•¡ì…˜
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }} # Slack Webhook URL
        status: ${{ job.status }}    # ë°°í¬ ì¡ ì‹¤í–‰ ìƒíƒœ
        message: |                   # ë°°í¬ ì•Œë¦¼ ë©”ì‹œì§€
          *Prod Deploy* `${{ github.repository }}`
          â€¢ *Status:* `${{ job.status }}`
          â€¢ *Server:* `${{ secrets.SSH_HOST }}`
          â€¢ *Image:* `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main`
          â€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Logs>

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì›Œí¬í”Œë¡œ ì‹¤í–‰ ì ˆì°¨ ì‹œê°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# ğŸ“‹ CI/CD íŒŒì´í”„ë¼ì¸ íë¦„ë„
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚   Git Push      â”‚ â† Developer pushes to main branch
# â”‚   (main)        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
#           â”‚
#           â–¼
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  ğŸ”§ BUILD JOB   â”‚
# â”‚                 â”‚
# â”‚ 1ï¸âƒ£  Checkout    â”‚ â† Download source code
# â”‚ 2ï¸âƒ£  Setup JDK   â”‚ â† Install Java 17 + Gradle cache
# â”‚ 3ï¸âƒ£  Run Tests   â”‚ â† Execute unit tests
# â”‚ 4ï¸âƒ£  Docker Buildâ”‚ â† Build container image
# â”‚ 5ï¸âƒ£  Push GHCR   â”‚ â† Upload to GitHub Container Registry
# â”‚ 6ï¸âƒ£  Slack Alert â”‚ â† Notify build status
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
#           â”‚
#           â–¼ (if build success)
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ ğŸš€ DEPLOY JOB   â”‚
# â”‚                 â”‚
# â”‚ 1ï¸âƒ£  SSH Connect â”‚ â† Connect to EC2 server
# â”‚ 2ï¸âƒ£  Pull Image  â”‚ â† Download new image from GHCR
# â”‚ 3ï¸âƒ£  Stop Old    â”‚ â† Remove existing container
# â”‚ 4ï¸âƒ£  Start New   â”‚ â† Run new container (port 80â†’8080)
# â”‚ 5ï¸âƒ£  Slack Alert â”‚ â† Notify deploy status
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸ”„ Parallel Processes:
# â€¢ Gradle caching (read-only)
# â€¢ Docker layer caching (GitHub Actions)
# â€¢ Concurrent builds (cancelled if new push)
#
# ğŸ“Š Monitoring Points:
# â€¢ Test results â†’ Slack
# â€¢ Build status â†’ Slack  
# â€¢ Deploy status â†’ Slack
# â€¢ All logs â†’ GitHub Actions UI
#
# ğŸ›¡ï¸  Security Features:
# â€¢ GHCR authentication via GitHub token
# â€¢ SSH key-based server access
# â€¢ Secrets management via GitHub
# â€¢ Read-only Gradle cache in CI